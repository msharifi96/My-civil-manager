import streamlit as st
import pandas as pd
import sqlite3
import base64

# Û±. Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
@st.cache_resource
def get_connection():
    conn = sqlite3.connect('civil_pro_final_v26.db', check_same_thread=False)
    return conn

conn = get_connection()
c = conn.cursor()

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„
c.execute('CREATE TABLE IF NOT EXISTS locations (id INTEGER PRIMARY KEY, name TEXT, level TEXT, p_type TEXT, parent_id INTEGER)')
c.execute('CREATE TABLE IF NOT EXISTS projects (id INTEGER PRIMARY KEY, loc_id INTEGER, name TEXT, company TEXT, contract_no TEXT, p_type TEXT)')
c.execute('CREATE TABLE IF NOT EXISTS project_folders (id INTEGER PRIMARY KEY, proj_id INTEGER, name TEXT, p_type TEXT)')
c.execute('CREATE TABLE IF NOT EXISTS project_files (id INTEGER PRIMARY KEY, proj_id INTEGER, folder_id INTEGER, file_name TEXT, file_blob BLOB)')
conn.commit()

st.set_page_config(page_title="Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø´Ø±ÛŒÙÛŒ", layout="wide")

# Û². Ø§Ø³ØªØ§ÛŒÙ„ ÙˆÛŒÙ†Ø¯ÙˆØ² Û±Û± Ùˆ Ø§ØµÙ„Ø§Ø­Ø§Øª Ø¨ØµØ±ÛŒ
st.markdown("""
    <style>
    [data-testid="stAppViewContainer"], .main { 
        direction: rtl; 
        text-align: right; 
        font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    
    .stTabs [data-baseweb="tab-list"] {
        direction: rtl;
        display: flex;
        justify-content: flex-start !important;
        gap: 10px;
    }

    div[data-testid="column"] button {
        border: none !important;
        background: rgba(255, 255, 255, 0.1) !important;
        border-radius: 6px !important;
        padding: 5px 10px !important;
        transition: all 0.2s ease;
        font-size: 1.1rem !important;
    }
    
    div[data-testid="column"] button:hover {
        background: rgba(0, 120, 215, 0.1) !important;
        transform: scale(1.02);
    }

    div[data-testid="column"] {
        display: flex;
        align-items: center; 
    }
    
    [data-testid="column"] { gap: 5px !important; }
    </style>
    """, unsafe_allow_html=True)

tabs = st.tabs(["ğŸ›¡ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù†Ø¸Ø§Ø±ØªÛŒ", "ğŸ‘· Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø´Ø®ØµÛŒ", "ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„", "ğŸ“ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…"])

# --- ØªØ§Ø¨Ø¹ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ø¨Ø§ Ù†Ù…Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯) ---
def render_dash(label):
    col_tree, col_view = st.columns([1, 2.5])
    with col_tree:
        st.subheader(f"Ø¢Ø±Ø´ÛŒÙˆ {label}")
        provs = pd.read_sql("SELECT * FROM locations WHERE level='Ø§Ø³ØªØ§Ù†' AND p_type=?", conn, params=(label,))
        for _, prov in provs.iterrows():
            with st.expander(f"ğŸ”¹ {prov['name']}"):
                cnts = pd.read_sql("SELECT * FROM locations WHERE level='Ø´Ù‡Ø±Ø³ØªØ§Ù†' AND parent_id=?", conn, params=(int(prov['id']),))
                for _, cnt in cnts.iterrows():
                    with st.expander(f"ğŸ“‚ {cnt['name']}"):
                        vls = pd.read_sql("SELECT * FROM locations WHERE level='Ø´Ù‡Ø± ÛŒØ§ Ø±ÙˆØ³ØªØ§' AND parent_id=?", conn, params=(int(cnt['id']),))
                        for _, vl in vls.iterrows():
                            with st.expander(f"ğŸ“ {vl['name']}"):
                                pjs = pd.read_sql("SELECT * FROM projects WHERE loc_id=? AND p_type=?", conn, params=(int(vl['id']), label))
                                for _, pj in pjs.iterrows():
                                    # ØªØºÛŒÛŒØ± Ø§ØµÙ„ÛŒ: Ù†Ù…Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ù‡ Ø¬Ø§ÛŒ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Ø¯Ú©Ù…Ù‡
                                    btn_label = f"ğŸ“„ Ù‚: {pj['contract_no']}" if pj['contract_no'] else f"ğŸ—ï¸ {pj['name']}"
                                    if st.button(btn_label, key=f"pj_{label}_{pj['id']}", use_container_width=True):
                                        st.session_state[f'act_{label}'] = pj.to_dict()

    with col_view:
        if f'act_{label}' in st.session_state:
            pj = st.session_state[f'act_{label}']
            st.header(f"ğŸ—ï¸ {pj['name']}") # Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            st.info(f"ğŸ¢ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±: {pj['company']} | ğŸ“„ Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: {pj['contract_no']}")
            flds = pd.read_sql("SELECT * FROM project_folders WHERE proj_id=?", conn, params=(int(pj['id']),))
            for _, fld in flds.iterrows():
                with st.expander(f"ğŸ“ {fld['name']}", expanded=True):
                    files = pd.read_sql("SELECT * FROM project_files WHERE folder_id=?", conn, params=(int(fld['id']),))
                    for _, fl in files.iterrows():
                        c_name, c_btns = st.columns([4, 1.5])
                        with c_name:
                            st.write(f"ğŸ“„ {fl['file_name']}")
                        with c_btns:
                            a1, a2, a3 = st.columns([1, 1, 1])
                            if a1.button("ğŸ—‘ï¸", key=f"del_{fl['id']}", help="Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†"):
                                c.execute("DELETE FROM project_files WHERE id=?", (int(fl['id']),)); conn.commit(); st.rerun()
                            if a2.button("ğŸ”—", key=f"lnk_{fl['id']}", help="Ù„ÛŒÙ†Ú© Ù…ÙˆÙ‚Øª"):
                                st.toast("Ù„ÛŒÙ†Ú© Ú©Ù¾ÛŒ Ø´Ø¯"); st.code(f"data:file;base64,{base64.b64encode(fl['file_blob']).decode()[:10]}...")
                            a3.download_button("ğŸ’¾", fl['file_blob'], fl['file_name'], key=f"dw_{fl['id']}", help="Ø°Ø®ÛŒØ±Ù‡")

with tabs[0]: render_dash("Ù†Ø¸Ø§Ø±ØªÛŒ ğŸ›¡ï¸")
with tabs[1]: render_dash("Ø´Ø®ØµÛŒ ğŸ‘·")

# --- Ø¨Ø®Ø´ Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª (Ø«Ø§Ø¨Øª Ù…Ø§Ù†Ù†Ø¯ Ù‚Ø¨Ù„) ---
with tabs[2]:
    st.subheader("ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ Ù…Ø¯Ø§Ø±Ú©")
    u_sec = st.radio("Ø¨Ø®Ø´:", ["Ù†Ø¸Ø§Ø±ØªÛŒ ğŸ›¡ï¸", "Ø´Ø®ØµÛŒ ğŸ‘·"], horizontal=True, key="up_sec_main")
    all_p = pd.read_sql("SELECT * FROM projects WHERE p_type=?", conn, params=(u_sec,))
    if not all_p.empty:
        c1, c2 = st.columns(2)
        with c1:
            s_p = st.selectbox("Ù¾Ø±ÙˆÚ˜Ù‡:", all_p['name'].tolist())
            p_id = all_p[all_p['
